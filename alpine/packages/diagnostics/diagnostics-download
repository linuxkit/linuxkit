#!/bin/sh

# Gather diagnostic data and write a .tar file to stdout

TEMP=$(mktemp -d diagnoseXXXXXXX)
trap 'rm -rf "$TEMP"' EXIT
mkdir $TEMP/moby
cd $TEMP/moby

# gather diagnostic data
date > "date"
uname -a > "uname -a"
ps uax > "ps -aux"
netstat -tulpn > "netstat -tulpn"
iptables -t nat -L > "iptables -t nat -L"
ifconfig -a > "ifconfig -a"
route -n > "route -n"
brctl show > "brctl show"
dmesg > dmesg
timeout -t 2 docker ps > "docker ps"
tail /var/log/docker.log > "docker.log"
mount > "mount"
df > "df"
ls -l /var &> "ls -l var"
ls -l /var/lib &> "ls -l var_lib"
ls -l /var/lib/docker &> "ls -l var_lib_docker"
/usr/bin/diagnostics > "diagnostics"
ping -w 5 8.8.8.8 &> "ping -w 5 8.8.8.8"
cp /etc/resolv.conf .
dig docker.com > "dig docker.com"
wget -O - http://www.docker.com/ &> "wget docker.com"

# send everything to the client
cd ..
tar -c .

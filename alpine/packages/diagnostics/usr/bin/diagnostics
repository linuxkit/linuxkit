#!/bin/sh

printf '\n'
DEV="$(find /dev -maxdepth 1 -type b ! -name 'loop*' | grep -v '[0-9]$' | sed 's@.*/dev/@@' | head -1 )"
[ $? -eq 0 ] && printf "✓ Drive found: %s\n" "$DEV" || printf "✗ No drive found\n"
DEV=$(mount | grep '/dev/.*da. on /var type')
[ $? -eq 0 ] && printf "✓ Drive mounted: %s\n" "$DEV" || printf "✗ No drive mounted\n"
INET=$(ifconfig eth0 2> /dev/null | grep 'inet addr')
[ $? -eq 0 ] && printf "✓ Network connected: %s\n" "$INET" || printf "✗ No network connection\n"
if [ "$(mobyplatform)" = "mac"  ]
then
	pgrep -fl '^/sbin/transfused'
	[ $? -eq 0 ] && printf "✓ Process transfused running\n" || printf "✗ No transfused process\n"
fi
if [ "$(mobyplatform)" = "windows" ]
then
	pgrep -fl '^/sbin/tap-vsockd'
	[ $? -eq 0 ] && printf "✓ Process tap-vsockd running\n" || printf "✗ No tap-vsockd process\n"
fi
DOCKER=$(pgrep -fl '^/usr/bin/dockerd')
[ $? -eq 0 ] && printf "✓ Process dockerd running: %s\n" "$DOCKER" || printf "✗ No dockerd process\n"
CONTAINERD=$(pgrep -fl '^docker-containerd')
[ $? -eq 0 ] && printf "✓ Process containerd running: %s\n" "$CONTAINERD" || printf "✗ No containerd process\n"
DOCKERPS=$(docker ps 2>&1)
DOCKERV=$(docker --version)
[ $? -eq 0 ] && printf "✓ Docker daemon working: %s\n" "$DOCKERV" || printf "✗ Docker ps failed: %s\n" "$DOCKERPS"
DIAGNOSTICS=$(pgrep -fl '^/usr/bin/diagnostics-server')
[ $? -eq 0 ] && printf "✓ Diagnostics server running: %s\n" "$DIAGNOSTICS" || printf "✗ No diagnostics server\n"
CONTAINERD=$(pgrep -fl '^/usr/bin/containerd')
[ $? -eq 0 ] && printf "✓ System containerd server running: %s\n" "$CONTAINERD" || printf "✗ No containerd server\n"
CONTAINERPS=$(containerd-ctr containers 2>&1)
[ $? -eq 0 ] && printf "✓ System containerd working\n" || printf "✗ containerd failed: %s\n" "$CONTAINERPS"

exit 0
